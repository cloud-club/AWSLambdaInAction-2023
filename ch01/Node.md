<aside>
🎨 클라우드 기반 함수? 이벤트 기반 백엔드 구축? 웹과 모바일을 함께 지원하기 위한 단일 백엔드 구성?에 대한 의문점을 가지고, AWS Lambda와 API Gateway를 알아본다.

</aside>

서비스 환경이 더 복잡해지거나, 확장성 및 가용성, 보안 등을 고려해야 함을 잊지 말아야 한다.

Lambda를 도입하면 추상화 레이어를 더 높게 설정할 수 있고, 개발자는 함수별로 모아 코드를 업로드하여 해당 기능을 플랫폼을 실행할 수 있다.

**각 함수는 직접 호출되거나 다른 AWS 자원에서 생성한 이벤트에 의해 트리거될 수 있다.**

e.g. 사진 업로드 시, 다른 해상도 화면에 적용하기 위한 썸네일 생성, 운영 중인 데이터베이스에 새 데이터를 저장하면 데이터 웨어하우스에 동기화 등

사용자가 자신의 사진을 업로드하면 다른 친구들과 공유할 수 있는 미디어 공유 애플리케이션의 구조

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/fb483f0f-f1b9-4a52-a494-e036ab7c1422)

이벤트 기반 접근 방식 → 개발 프로세스 단순화, 애플리케이션의 비즈니스 로직을 쉽게 디자인하고 확장

위 아키텍처에서 확인해볼 수 있듯이, 애플리케이션의 기능이 추가되어도 파일 저장소와 데이터베이스 간에 형성된 관계 덕분에 **파일 업로드 프로세스와 데이터베이스 업데이트가 독립적으로 작동한다.**

→ 이벤트 기반 접근 방식의 장점

클라우드 컴퓨팅 시대로 오면서 개발자들이 인프라를 관리할 부담을 덜어주었다. 개발자들은 인프라 신경쓸 필요 없이 개발에 집중할 수 있게 되었다. AWS Lambda도 사용하게 되면 인프라 관리에 대한 부담을 적게 가져갈 수 있다.

**AWS Lambda에서는 Lambda 함수를 등록하고 이 함수를 호출하는 식으로 동작된다.** 

> 특정 파일이 업로드되거나 데이터베이스 항목이 수정됨(이벤트) ➡️ AWS Lambda 함수 실행(Lambda 함수가 이벤트 발생에 반응)
> 

## 1.1 AWS Lambda 소개

> 물리적 서버의 가상 컨테이너 내에서 코드가 실행되지만, 인프라는 신경 쓰지 않아도 되는 서버리스 서비스
> 

기존에 물리 서버를 두거나 클라우드 기반 가상 서버를 두었을 때 접근 방식과 AWS Lambda는 다르다. 여러 함수로 구성된 논리적인 구성과 이들 함수를 실행하는 서비스만 신경쓰면 된다. 각 함수는 컨테이너에서 실행된다. 컨테이너는 일종의 서버 가상화 방식인데, AWS Lambda를 사용할 때 이런 인프라를 관리할 필요는 없다.

> 각 함수는 컨테이너에서 실행한다. 각 컨테이너는 운영체제의 커널이 격리된 환경을 구현하는 서버 가상화 방식이다. AWS Lambda를 사용하면 물리적 서버의 가상 컨테이너 내에서 코드가 실행되지만, *그러한 인프라를 관리할 필요는 없다.* 그런 측면에서 이러한 접근 방식을 ***서버리스(serverless)***로 정의하고 있다.
> 

콘솔에서 함수 이름 지정 + 코드 작성, 그리고 다음 환경을 구성한다.

- 함수 실행을 위한 max memory size ⇒ 메모리 크기는 CPU 성능과 비례
- 함수 완료와 무관한 함수 실행 timeout
- AWS 리소스 접근 권한에 대한 IAM Role

Lambda의 비용 산정

- 총 호출 횟수
- ms 단위의 실행 시간 → 메모리와 함께 선형으로 증가

본 책에서는 JS와 Python으로 예제를 실행하지만, NodeJS, Java 등 다른 런타임도 다수 지원한다.

Lambda에서 지원하지 않는 언어의 경우, 지원되는 런타임을 wrapper로 사용하고, 해당 언어로 작성된 프로그램을 zip으로 업로드

Lambda 함수 호출 시, input에 **event**와 **context**를 지정해야 한다.

- event: 함수에 대한 input param을 보내는 방법 (json)
- context: 서비스에서 실행 환경과 이벤트 수신 및 처리 방법을 설명

```jsx
export const handler = async (event) => {
  // TODO implement
  const response = {
    statusCode: 200,
    body: JSON.stringify('Hello from Lambda!'),
  };
  return response;
};
```

처음 함수를 만들면 위와 같은 예제가 기본적으로 나온다. event란 함수에 대한 입력 매개변수를 보내는 방법. JSON으로 표현된다.

### 동기 호출

함수를 **동기적으로 호출**하여 결과를 반환하는 방식

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/e7c60203-bad8-4ce3-80ff-da7a34fe3e0c)

```python
def lambda_handler (event, context):
  result = event['value1'] + event['value2']
  return result
```

### 비동기 호출

함수를 **비동기적으로 호출**하여 결과를 반환하는 방식 → 결과가 즉시 반환되지 않는다 !

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/f6fb6917-ef79-487f-9acf-78ea4eeecc93)

함수가 종료되면 세션 정보를 유지하지 않는 방식 → ***‘상태 비저장(stateless)’***

e.g. 공유 파일이나 데이터베이스 등의 다른 리소스를 수정하고 이메일 등의 알람 보낼 때 유용, 로깅 기능 구현

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/23034ad6-4bf5-4300-9f92-44a3018da2f4)

CASE 1) 로깅 구현

- 람다는 CloudWatch 서비스에 로그를 전달하는 기능을 기본적으로 제공한다.

```python
def lambda_handler(event, context):
  print(event[‘message’])  # print로 편리하게 로그 출력
  return
```

CASE 2) 객체 저장소(e.g. S3)나 NoSQL 데이터베이스(e.g. DynamoDB) 등의 리소스에 의해 생성된 이벤트 처리

- 사용자가 고해상도 사진을 파일에 업로드 → 이벤트로 입력되어 함수 트리거 → 썸네일 파일을 다시 파일 저장소에 저장

## 1.2 백엔드 함수 구성하기

> 대개 애플리케이션은 end user에게 도달하기 전, 외부에 로직 및 상태 일부를 유지
→ 이 외부 로직을 프론트 기반 애플리케이션 시각에서 백엔드라 일컫는다.
> 

백엔드를 구축하기 위해

1. 웹 애플리케이션을 서버에 배포
2. 필요한 비즈니스 로직을 구현한 여러 개의 람다 함수를 호출 ***⇒ 서버리스 백엔드 !***

***서버에 전체 백엔드 웹 애플리케이션을 개발 및 배포하는 대신 여러 개의 Lambda 함수를 구현해두고 이를 호출할 수도 있다. 이러한 방식이 Serverless***

기존에는 API 방식을 사용해서 API를 호출하면 백엔드에서 무언가를 수행하여 결과를 반환 받는다.

이 각 API 호출 시 수행되는 로직들을 AWS Lambda를 사용하여 **백엔드 기반 함수**로 구현할 수 있다.

> 모든 백엔드 API를 AWS Lambda가 관리하는 기능으로 구현할 수 있다.
> 

기존 백엔드 API 방식을 AWS Lambda를 쓰게 바꿀 수 있다! AWS Lambda 기능을 클라이언트 애플리케이션의 백엔드 API로 직접 사용할 수 있다!

IAM Policy나 Role 기반으로 람다 함수가 수행할 수 있는 작업과 리소스를 제어할 수 있다.

- 코드 실행에 필요한 보안 관리
- 각 람다 함수에 대한 보안 권한 조정이 가능하여 최소 권한 설정이 쉬움

## 1.3 단일 백엔드 구성하기

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/36bfaa8f-4bd3-407d-b15b-68adcebe0e13)

단일 백엔드, 그리고 모든 사용자 애플리케이션에 대해 동일한 상호작용과 데이터 흐름을 갖는 아키텍처이다.

따라서 새로운 기능을 만드려면? 하나 이상의 백엔드 플랫폼에 적용하기 위해 진행해야 하는 테스트가 많아져 개발 자원이 낭비되는 상황 발생 가능

→ 데이터베이스와 구조화되지 않은 컨텐츠(정적 파일)로 분할하여 아키텍처 단순화

1. 웹 인터페이스를 파일 저장소에 추가
2. JS 클라이언트 애플리케이션을 사용하여 비즈니스 로직 일부를 웹 브라우저로 이동

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/f8b5d30e-2441-46fa-878e-88e57339e69f)

위 아키텍처는, 지원하는 클라이언트 장치에 따라 달라지는 프론트 구현을 백엔드에서 분리하는 단계이다. 이로써 새로운 장치를 추가하기 용이해졌다.

각 API 호출은 람다로 구현할 수 있는 백엔드 기반 함수로, 모든 백엔드 API를 람다가 관리하는 방식의 로직이다. 이렇게 람다의 서버리스 백엔드 하나로 모든 클라이언트에 동일 API를 제공할 수 있다!

**⇒ 즉, 람다의 기능을 클라이언트 애플리케이션의 백엔드 API로 사용할 수 있다**

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/521cec4f-1676-40e4-b391-f9a8bf75e5ef)

## 1.4 이벤트 기반 애플리케이션

**구독 기능**으로 클라이언트 애플리케이션의 요청이나 애플리케이션에서 사용하는 리소스 변경에 반응할 수 있도록 백엔드 내부 동작 변경 가능

**중앙 집중식 워크플로우 (X) →→→ 리소스 간의 관계성 (O)**

- 분산 애플리케이션의 특성을 띠게 됨
- 여러 리소스의 동기식 트랜잭션 지양
- 각 함수를 이벤트 기반으로 독립적으로 작동 → 데이터 일관성 유지!

> 데이터 일관성? 사용자가 일관된 동일 데이터를 볼 수 있도록 하는 것
> 

웹 브라우저/모바일 앱에서 사진을 업로드하고 모든 사용자 또는 친구와 공개적으로 공유할 수 있는 사진 사이트를 만든다고 가정.

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/6bb5f52a-ec22-4dee-b74e-73a14f5ea6b6)

- 여러 기능(콘텐츠 업로드, 업데이트, 목록 불러오기 등)은 하나의 람다 함수를 사용하여 구현
- 멀티미디어 콘텐츠를 위한 파일 저장소와 사용자 테이블과 미디어 간 관계 등을 처리하는 데이터베이스를 분리

근데 위 기능에 추가적으로 몇 가지 백엔드 기능을 추가하려 하는데 백엔드 저장소에서 어떤 이벤트가 발생하는지에 따라 구현할 기능이 다르면, 저장소에서 오는 이벤트를 통해 추가적인 함수를 만들어 구현할 수 있다.

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/a51f4bd1-3bc9-461e-9ff2-9da1f233a962)

람다 함수를 이벤트에 등록하면 동작 관계에 따라 자동적이고 연쇄적으로 실행할 수 있다.

*e.g. 콘텐츠 메타데이터 업데이트 → 파일 저장소에서 생성된 이벤트에 의해 첫 번째 함수가 트리거되어 데이터베이스상의 메타데이트 업데이트 → 다음으로 콘텐츠를 볼 수 있는 모든 사용자의 콘텐츠 목록을 업데이트하는 두 번째 함수가 트리거*

API처럼 클라이언트 애플리케이션에서 직접 요청되었을 때 Lambda 함수가 호출될 수도 있지만, 다른 리소스에서 생성되는 이벤트를 구독할 수도 있다.

> 이렇게 클라이언트 애플리케이션의 직접 요청뿐만 아니라 애플리케이션에서 사용하는 리소스 변경에도 반응할 수 있도록 백엔드의 내부 동작을 변경할 수 있다.
> 

그러니까.... 꼭 API로 클라이언트가 호출되어서 Lambda 함수가 호출되는 게 아니라 DB나 파일저장소에 어떤 이벤트가 발생되었을 때(새로 무언가 저장되었다 등등..)에도 Lambda 함수를 호출시킬 수 있다.

## 1.5 클라이언트에서 함수 호출하기

람다 함수를 호출하기 위해 Invoke API를 설계할 수 있다.

Amazon Cognito를 사용하여 인증 및 권한 부여를 쉽게 할 수 있다.

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/0faa0b9b-ce08-4e95-b5fd-c924959718ce)

클라이언트에서 Lambda 함수를 호출 할 때 Invoke API를 통해서 함수를 호출한다. 이때 클라이언트가 권한이 있는지를 확인하는 과정이 필요하다.

![image](https://github.com/cloud-club/AWSLambdaInAction-2023/assets/76844285/d03e516c-f976-49fb-92c0-2b8d7a97594b)

Amazon API Gateway는 백엔드의 부하를 줄이기 위해서 다양한 기능을 제공하는데, AWS Lambda 함수를 이 Amazon API Gateway를 통해 제공함으로써 아무 클라이언트가 직접 실행하거나 접근하는 것을 방지한다. 보안이 뛰어나다!

Amazon API Gateway를 통해 일부 API는 공개할 수도 있는데 이 경우 인증키가 필요하지 않다.

[AWS Lambda 인 액션](https://www.yes24.com/Product/Goods/57735827)

위 책 내용을 바탕으로 정리함.
